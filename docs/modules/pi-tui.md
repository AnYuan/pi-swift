# `pi-tui` Module Notes

## Status

- `P4-1` is complete.
- `P4-2` is complete (baseline input/editor/key system).
- This document tracks the verified `P4-1` + `P4-2` baseline and remaining `pi-tui` work for later phases (`P4-3` / `P4-4` / `P4-5`).

## Implemented (P4-1 foundation slice)

### Terminal Abstraction (test-oriented)

- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUITerminal.swift`
- Introduced `PiTUITerminal` protocol for:
  - lifecycle (`start` / `stop`)
  - viewport dimensions (`columns` / `rows`)
  - cursor visibility (`hideCursor` / `showCursor`)
  - screen mutations (`clearScreen`, `writeLine`, `clearLine`)
- Added `PiTUIVirtualTerminal` for deterministic tests and operation logging.
  - Virtual terminal now uses the same ANSI-safe line sanitization semantics as the TUI/ANSI terminal path.
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIANSITerminal.swift`
  - writer-based ANSI/VT terminal adapter that translates row writes/clears into escape sequences
  - test hooks for input simulation and resize callbacks (supports unit testing without a real process terminal)
  - synchronized output begin/end markers (`CSI ?2026 h/l`)
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIANSIText.swift`
  - ANSI-aware visible-width calculation (CSI + OSC hyperlink sequence skipping)
  - display-width handling for wide characters (CJK/emoji ranges) and zero-width scalars (combining marks / ZWJ / variation selectors)
  - ANSI-safe visible-width truncation (preserves escape sequences)
  - line-end reset helper to prevent style leakage across terminal rows
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIProcessTerminal.swift`
  - host-based process terminal scaffold (`PiTUITerminalHost` + `PiTUIProcessTerminal`)
  - delegates ANSI rendering to `PiTUIANSITerminal`
  - bridges host input/resize callbacks into `PiTUI` terminal interface
  - includes minimal `PiTUIStandardIOHost` stdout-backed implementation (stdin/raw-mode/signal wiring deferred)

### Render Buffer + Differential Plan

- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIRenderBuffer.swift`
- Introduced a render-state buffer that tracks:
  - `previousLines`
  - `previousWidth`
  - `maxLinesRendered`
- Supports:
  - first-render full redraw
  - width-change full redraw
  - `clearOnShrink` full redraw
  - differential row edits + extra-row clearing

### Minimal Core TUI Render Loop

- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/TUI.swift`
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIRenderScheduler.swift`
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIComponent.swift`
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUICursor.swift`
- Current `PiTUI` foundation supports:
  - child component composition (`render(width:)`)
  - `start()` / `stop()`
  - `requestRender(force:)` with scheduler-driven coalescing (default immediate scheduler)
  - test-only/manual scheduler for deterministic render queue flushing
  - scheduler-generation isolation so stale pending renders are ignored across `stop()` / restart boundaries
  - render-buffer cache reset on `stop()` so restart always performs a fresh redraw
  - `clearOnShrink` toggle
  - `fullRedraws` counter (regression observability)
  - cursor-marker extraction + optional hardware cursor positioning
  - ANSI-safe line sanitization in render loop (visible-width truncation + line-end reset) before diffing
  - synchronized output batching around full and differential render passes
  - viewport projection to terminal height (renders the bottom visible window of long content)
  - cursor-position projection into visible viewport coordinates for long content

## Verified Regression Coverage (current slice)

- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIDifferentialRenderingTests.swift`
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIANSITerminalTests.swift`
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIANSITextTests.swift`
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIRenderSchedulingTests.swift`
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUICursorTests.swift`
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUISynchronizedOutputTests.swift`
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIProcessTerminalTests.swift`
- Covered scenarios (derived from `../pi-mono/packages/tui/test/tui-render.test.ts`):
  - width change triggers full redraw
  - content shrink clears stale rows when `clearOnShrink` is enabled
  - content shrink without `clearOnShrink` uses differential tail clears (no forced full redraw)
  - differential rendering updates only a changed middle line
  - content -> empty -> content transition
  - long content renders bottom viewport window
  - appending content shifts viewport to latest rows
  - shrink then later line change still targets correct row
  - only first line changes
  - only last line changes
  - multiple non-adjacent lines change
  - styled line gets reset at line end (style-leak prevention baseline)
  - ANSI-styled line truncates by visible width before diffing/rendering
- ANSI terminal adapter coverage:
  - hide/show cursor VT sequences
  - clear screen VT sequence
  - row-targeted line write + clear + truncation
  - resize/input callback plumbing
  - out-of-bounds row no-op safety
  - ANSI-visible-width truncation + automatic reset append for styled lines
  - synchronized output begin/end VT markers
- ANSI text utility coverage:
  - visible width ignores CSI color sequences
  - visible width ignores OSC-8 hyperlink wrappers
  - visible width handles wide and combining scalars
  - visible-width truncation preserves ANSI sequences
  - visible-width truncation does not split wide characters
  - reset helper behavior for ANSI vs plain text lines
- Render scheduling coverage:
  - multiple `requestRender()` calls coalesce before scheduler flush
  - resize-triggered render coalesces with explicit render request
  - pending scheduled render is ignored after `stop()`
  - stale scheduled render from previous session does not run after restart
  - restart forces a fresh render even when content is unchanged (cache invalidated across sessions)
- Cursor handling coverage:
  - cursor marker removal from rendered output
  - cursor row/column positioning in virtual terminal
  - ANSI-aware cursor column calculation (ignores style escape sequences before marker)
  - wide-character cursor column accounting (`ä½ ` counts as width 2)
  - cursor marker row projection from long content into visible viewport
  - no-marker path keeps hardware cursor hidden
- Synchronized output coverage:
  - first render wrapped in begin/end sync markers
  - differential render wrapped in begin/end sync markers
  - no-op render does not emit sync markers
- Process terminal scaffold coverage:
  - host writer receives delegated ANSI output
  - host input/resize callbacks bridge to `PiTUIProcessTerminal` callbacks and dimension updates
  - `start()` / `stop()` host lifecycle delegation
  - idempotent `start()` / `stop()` host lifecycle calls
  - late host callbacks after `stop()` are ignored (no stale input/resize delivery)
  - `PiTUIStandardIOHost` writer injection + dimension clamping

## Deferred Beyond `P4-1` (Later Phases)

- Full stdin/raw-mode/signal-driven process terminal integration (current `PiTUIStandardIOHost` is a minimal stdout-backed scaffold); this can continue as incremental hardening without blocking `P4-2`
- Overlay composition and overlay viewport/layout behavior (`P4-3`)
- Advanced viewport/scrollback overwrite semantics matching `pi-mono` cursor-movement internals (can be covered via later regression parity work in `P4-5`)
- Additional overflow/visible-width parity edge cases and broader `pi-mono` test alignment (`P4-5`)

These are tracked as follow-on work and do not block `P4-1` completion.

## `P4-2` Progress (Input/Editor/Keys Foundation)

- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiUndoStack.swift`
  - Generic undo snapshot stack with injectable clone-on-push behavior
  - `push`, `pop`, `clear`, `length`
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiKillRing.swift`
  - Emacs-style kill ring foundation
  - supports `push` (with accumulate + prepend/append semantics), `peek`, `rotate`, `length`
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIEditingPrimitivesTests.swift`
  - undo stack push/pop/clear
  - clone-on-push detachment via custom clone closure
  - kill-ring accumulation and yank-pop rotation semantics
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIStdinBuffer.swift`
  - chunked escape-sequence buffering/splitting (CSI/OSC/DCS/APC/SS3 + SGR mouse)
  - bracketed-paste extraction with dedicated paste callback
  - high-byte `Data([byte > 127])` compatibility conversion to `ESC` meta sequence
  - `flush`, `clear`, `destroy`, and `getBuffer` helpers
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIStdinBufferTests.swift`
  - chunked CSI/OSC/SGR mouse sequence completeness handling
  - bracketed paste complete/chunked flows
  - high-byte input compatibility conversion
  - flush/empty-input compatibility behavior
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIKeys.swift`
  - minimal key parsing/matching foundation for legacy terminal input
  - supports printable chars, common specials, arrows/home/end (CSI + SS3), legacy ctrl combos, and selected alt-prefixed sequences
  - includes kitty-protocol-active toggle for compatibility gating of legacy alt-prefixed parsing (subset behavior)
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIKeysTests.swift`
  - legacy/SS3 navigation keys
  - ctrl-letter/symbol parsing
  - alt-prefixed parsing gating with kitty protocol flag
  - alias-aware `matchesKey` normalization (`esc`/`escape`, `return`/`enter`, modifier order)
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIInputModel.swift`
  - single-line text input state model (value + UTF-16 cursor offset)
  - grapheme-aware left/right movement, backspace, forward delete
  - undo snapshots via `PiUndoStack`
  - bracketed paste buffering/atomic insertion
  - word movement/deletion (`alt+left/right`, `ctrl+w`, `alt+d`) and line kills (`ctrl+u`, `ctrl+k`)
  - kill ring integration with yank / yank-pop (`ctrl+y`, `alt+y`)
  - minimal `handleInput` integration with `PiTUIKeys` subset (`left/right/home/end`, `ctrl+a/e/z`, backspace, delete, word/kill/yank commands)
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIInputModelTests.swift`
  - insertion and cursor movement
  - grapheme-aware emoji cursor/deletion behavior
  - atomic undo for chunked bracketed paste
  - word movement/deletion behavior
  - kill ring line-delete + yank flow and yank-pop cycling
  - control-character filtering
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIInputComponent.swift`
  - minimal single-line input component wrapper around `PiTUIInputModel`
  - prompt rendering + `PiTUICursor.marker` insertion for hardware cursor projection
  - submit/escape callbacks
  - prompt history navigation integration (`up`/`down`) via `PiTUIEditorHistory`
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIInputComponentTests.swift`
  - prompt/cursor-marker rendering
  - input delegation to model
  - submit/escape callbacks
  - integration with `PiTUI` hardware cursor positioning
  - history browse up/down + draft restore
  - typing exits history browsing mode
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIEditorHistory.swift`
  - prompt history storage/navigation model for editor-like components
  - trimmed history entries, consecutive-duplicate suppression, max-100 retention
  - up/down browsing with current-draft capture/restore and explicit browsing reset
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIEditorHistoryTests.swift`
  - empty-history behavior
  - dedupe/trim/limit semantics
  - history browse up/down and draft restore
  - exiting history mode when current draft updates
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIEditorKeybindings.swift`
  - editor action -> keybinding manager (subset of `pi-mono` editor actions)
  - default bindings + override config + replaceable global manager
  - `InputModel` / `InputComponent` now use action-based matching instead of hard-coded key checks
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIEditorKeybindingsTests.swift`
  - default binding matches
  - custom override behavior
  - replaceable global manager behavior
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIEditorModel.swift`
  - multiline text editor state foundation (`lines` + cursor line/UTF-16 column)
  - newline normalization in `setText`
  - single/multi-line insertion at cursor
  - newline split, grapheme-aware backspace/delete, cross-line merge behavior
  - cursor left/right/up/down and undo snapshots
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIEditorModelTests.swift`
  - newline normalization and cursor placement
  - multiline insertion/splitting
  - grapheme-aware delete/backspace
  - cross-line cursor movement
  - undo across multiline edits
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIEditorComponent.swift`
  - minimal multiline editor component wrapper around `PiTUIEditorModel`
  - prompt-on-first-line rendering + cursor marker insertion
  - submit/escape callbacks
  - basic navigation/edit handling via editor keybindings manager (`up/down/left/right`, line start/end, delete/backspace, undo)
  - `shift+enter` inserts newline (via `PiTUIKeys` kitty-aware parsing)
  - prompt history navigation integration (`up/down`) with draft restore, using `PiTUIEditorHistory`
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIEditorComponentTests.swift`
  - multiline render output with cursor marker
  - typing/newline/submit flow
  - multi-line arrow navigation
  - onChange behavior
  - `PiTUI` hardware cursor integration on non-first line
  - editor history browse/draft restore and non-history cursor-move precedence when not on first line

## `P4-3` Progress (List/Overlay/Layout Foundation)

- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUISelectList.swift`
  - `SelectList`-style component (`PiTUISelectList`) with:
    - items + filtered view
    - wrapped up/down selection navigation
    - confirm/cancel callbacks
    - description single-line normalization
    - scroll info footer when list exceeds `maxVisible`
  - `PiTUISelectItem` and theme hooks (`PiTUISelectListTheme`)
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUISelectListTests.swift`
  - multiline-description normalization
  - filter/reset/no-match behavior
  - wrapped navigation + selection-change callback
  - confirm/cancel callbacks
  - scroll-info rendering when list is clipped
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIOverlayLayout.swift`
  - overlay geometry planner (`PiTUIOverlayLayoutPlanner`) with:
    - centered/default placement
    - anchor-based placement (`topLeft`, `topRight`, `bottomLeft`, `bottomRight`, `center`)
    - absolute and percent row/column positioning
    - width/height/min/max resolution via `PiTUISizeValue`
    - margin-aware viewport clamping and offset handling
  - supporting types:
    - `PiTUIOverlayOptions`
    - `PiTUIOverlayAnchor`
    - `PiTUIOverlayMargin`
    - `PiTUIOverlayResolvedLayout`
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIOverlayLayoutTests.swift`
  - default centering and width clamp behavior
  - percent width + min-width resolution
  - anchor/offset/margin clamping
  - percent row/column placement on remaining space
  - max-height percent resolution + viewport clamp
- Extended `/Users/anyuan/Development/pi-swift/Sources/PiTUI/TUI.swift`
  - overlay stack support via `showOverlay(...)` / `hideOverlay()`
  - viewport-time overlay compositing with later overlays rendered on top
  - overlay width/maxHeight application using `PiTUIOverlayLayoutPlanner`
  - hide-top-overlay restores previous overlay visibility without restarting `PiTUI`
  - ANSI-stripping visible-cell compositing path (safety-first foundation for overlay rendering over styled base content)
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIOverlayCompositionTests.swift`
  - resolved-width percentage passed to overlay component render
  - stacked overlay z-order and hide-restore behavior
  - non-interfering overlays at different anchors
  - `maxHeight` truncation in TUI composition path
  - no-crash overlay compositing over ANSI-styled base content and wide characters
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUISettingsList.swift`
  - `SettingsList`-style component foundation (`PiTUISettingsList`) with:
    - aligned label/value rendering
    - up/down selection wrap navigation
    - Enter/Space value cycling (`values`)
    - submenu plumbing (`submenu` factory, input delegation, done callback restore)
    - description rendering + hint lines
    - optional inline search query + filtered view + no-match handling
    - `updateValue(id:newValue:)` support
  - supporting types:
    - `PiTUISettingItem`
    - `PiTUISettingsListTheme`
    - `PiTUISettingsListOptions`
    - `PiTUIInteractiveComponent`
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUISettingsListTests.swift`
  - aligned render + hint presence
  - wrapped up/down navigation
  - Enter/Space value cycling + `onChange`
  - cancel callback
  - search filter/backspace and no-match rendering
  - selected description wrapping
  - scroll indicator rendering
  - submenu render/delegate/done update and cancel flows

## `P4-3` Verification

- `swift test --filter PiTUITests` passed (136 `PiTUI` tests) on 2026-02-24
- `swift build` passed on 2026-02-24
- `P4-3` scope now covered in Swift:
  - `PiTUISelectList`
  - `PiTUISettingsList`
  - overlay options/layout planner + overlay visibility/stack composition in `PiTUI`

## `P4-4` Progress (Markdown / Images / Autocomplete Foundation)

- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIAutocomplete.swift`
  - local path autocomplete foundation (`PiTUICombinedAutocompleteProvider`) with:
    - forced file suggestion prefix extraction
    - slash-command guard for `/command` line starts
    - quoted path continuation (`"..."`, `@"..."`)
    - direct path and `@` attachment path suggestions from local filesystem
    - directory-first sorting
    - apply-completion logic with quote-deduplication and attachment file trailing-space behavior
  - supporting types:
    - `PiTUIAutocompleteItem`
    - `PiTUIAutocompleteSuggestions`
    - `PiTUIAutocompleteApplyResult`
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIAutocompleteTests.swift`
  - forced `/` extraction after trailing space
  - slash-command no-trigger guard
  - quoted path suggestion generation and continuation
  - quoted completion application without duplicate closing quote
  - `@` attachment file/directory completion application semantics
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUITerminalImage.swift`
  - `PiTUITerminalImage.isImageLine(_:)` helper for Kitty/iTerm2 image protocol line detection
  - intended for markdown/image rendering paths to avoid wrapping image payload rows as text
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUITerminalImageTests.swift`
  - iTerm2 and Kitty detection in start/middle/end positions
  - very long line regression coverage
  - mixed ANSI + image sequences
  - negative cases (plain text / ANSI-only / partial sequences)
- Added `/Users/anyuan/Development/pi-swift/Sources/PiTUI/PiTUIMarkdown.swift`
  - `PiTUIMarkdown` component foundation with:
    - width-aware render caching + `invalidate`
    - paragraph wrapping
    - basic heading/list/quote line rendering
    - simple inline formatting normalization (`**`, `` ` ``, links -> `text (url)`)
    - image protocol line passthrough using `PiTUITerminalImage.isImageLine(_:)`
- Added `/Users/anyuan/Development/pi-swift/Tests/PiTUITests/PiTUIMarkdownTests.swift`
  - paragraph wrapping width constraints
  - heading/list/quote/link rendering smoke coverage
  - image-line no-wrap regression
  - cache-by-width + invalidate behavior
